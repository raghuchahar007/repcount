# M3-M5 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build member-facing pages (home, diet, workout, feed, profile), essential engagement (streaks, badges, leaderboard), owner attendance check-in, and public gym page with lead form.

**Architecture:** Member routes use `requireAuth → requireMember` middleware + a new `requireMemberContext` middleware that resolves `Member.findOne({ user: req.user.userId })` and attaches `req.member` + `req.memberGymId`. Diet/workout are pre-built templates embedded in client-side constants (no DB). Public routes have no auth. Badge earning is triggered server-side on attendance check-in.

**Tech Stack:** Express 4, Mongoose, React 18, React Router v6, Tailwind CSS v4, Zod validation

---

### Task 1: Member Context Middleware + Member API Routes

**Files:**
- Create: `server/src/middleware/memberContext.ts`
- Create: `server/src/routes/me.routes.ts`
- Modify: `server/src/app.ts` (add route registration)

**What to build:**

1. **`memberContext.ts`** — middleware that finds the Member record for the logged-in user:
```typescript
import { Request, Response, NextFunction } from 'express'
import { Member, IMember } from '../models/Member'
import { Document, Types } from 'mongoose'

declare global {
  namespace Express {
    interface Request {
      member?: Document<unknown, {}, IMember> & IMember & { _id: Types.ObjectId }
    }
  }
}

export async function requireMemberContext(req: Request, res: Response, next: NextFunction) {
  try {
    const member = await Member.findOne({ user: req.user!.userId })
    if (!member) {
      return res.status(404).json({ error: 'Member profile not found' })
    }
    req.member = member
    next()
  } catch {
    return res.status(500).json({ error: 'Failed to load member profile' })
  }
}
```

2. **`me.routes.ts`** — all member-facing API endpoints:
```typescript
import { Router, Request, Response } from 'express'
import { z } from 'zod'
import { requireAuth } from '../middleware/auth'
import { requireMember } from '../middleware/roleGuard'
import { requireMemberContext } from '../middleware/memberContext'
import { validate } from '../middleware/validate'
import { Member } from '../models/Member'
import { Membership } from '../models/Membership'
import { Attendance } from '../models/Attendance'
import { Progress } from '../models/Progress'
import { GymPost } from '../models/GymPost'
import { Gym } from '../models/Gym'

const router = Router()

// All routes: requireAuth → requireMember → requireMemberContext
router.use(requireAuth, requireMember, requireMemberContext)
```

   **Endpoints:**

   a. `GET /api/me/home` — member home data
   - Returns: member profile, current membership (latest active), streak count, recent attendance (30 days), badges, gym name
   - Streak calculation: count consecutive days backwards from today in Attendance where check_in_date matches
   ```typescript
   router.get('/home', async (req: Request, res: Response) => {
     try {
       const member = req.member!
       const gymId = member.gym

       const [gym, latestMembership, attendanceRecords] = await Promise.all([
         Gym.findById(gymId).select('name').lean(),
         Membership.findOne({ member: member._id, status: 'active' }).sort({ expiry_date: -1 }).lean(),
         Attendance.find({ member: member._id, gym: gymId })
           .sort({ check_in_date: -1 }).limit(90).lean(),
       ])

       // Compute streak
       let streak = 0
       const today = new Date()
       today.setHours(0, 0, 0, 0)
       const checkDates = new Set(
         attendanceRecords.map(a => new Date(a.check_in_date).toISOString().split('T')[0])
       )
       for (let i = 0; i < 365; i++) {
         const d = new Date(today)
         d.setDate(d.getDate() - i)
         const key = d.toISOString().split('T')[0]
         if (checkDates.has(key)) {
           streak++
         } else if (i > 0) {
           break
         }
         // If today hasn't been checked in yet, skip day 0 and check from yesterday
         if (i === 0 && !checkDates.has(key)) continue
       }

       // Last 30 days attendance grid
       const thirtyDaysAgo = new Date(today)
       thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 29)
       const recentDates = attendanceRecords
         .filter(a => new Date(a.check_in_date) >= thirtyDaysAgo)
         .map(a => new Date(a.check_in_date).toISOString().split('T')[0])

       res.json({
         member: {
           _id: member._id,
           name: member.name,
           phone: member.phone,
           goal: member.goal,
           diet_pref: member.diet_pref,
           badges: member.badges,
         },
         gym: { name: gym?.name || '' },
         membership: latestMembership,
         streak,
         attendanceDays: recentDates,
       })
     } catch (err) {
       console.error('Home error:', err)
       res.status(500).json({ error: 'Failed to load home data' })
     }
   })
   ```

   b. `GET /api/me/profile` — full profile for editing
   ```typescript
   router.get('/profile', async (req: Request, res: Response) => {
     const member = req.member!
     const memberships = await Membership.find({ member: member._id })
       .sort({ created_at: -1 }).lean()
     res.json({ member: member.toObject(), memberships })
   })
   ```

   c. `PUT /api/me/profile` — update goal, diet_pref
   ```typescript
   const updateProfileSchema = z.object({
     goal: z.enum(['weight_loss', 'muscle_gain', 'general']).optional(),
     diet_pref: z.enum(['veg', 'nonveg', 'egg']).optional(),
   })

   router.put('/profile', validate(updateProfileSchema), async (req: Request, res: Response) => {
     try {
       const updated = await Member.findByIdAndUpdate(
         req.member!._id,
         { $set: req.body },
         { new: true }
       ).lean()
       res.json(updated)
     } catch (err) {
       console.error('Update profile error:', err)
       res.status(500).json({ error: 'Failed to update profile' })
     }
   })
   ```

   d. `GET /api/me/feed` — gym posts for member's gym
   ```typescript
   router.get('/feed', async (req: Request, res: Response) => {
     try {
       const posts = await GymPost.find({
         gym: req.member!.gym,
         is_published: true,
       }).sort({ created_at: -1 }).lean()

       const postsWithJoined = posts.map(p => ({
         ...p,
         participantCount: p.participants?.length || 0,
         hasJoined: p.participants?.some(
           (pid: any) => pid.toString() === req.member!._id.toString()
         ) || false,
       }))

       res.json(postsWithJoined)
     } catch (err) {
       console.error('Feed error:', err)
       res.status(500).json({ error: 'Failed to load feed' })
     }
   })
   ```

   e. `POST /api/me/feed/:postId/join` — join a challenge
   ```typescript
   router.post('/feed/:postId/join', async (req: Request, res: Response) => {
     try {
       const post = await GymPost.findOne({
         _id: req.params.postId,
         gym: req.member!.gym,
         post_type: 'challenge',
       })
       if (!post) return res.status(404).json({ error: 'Challenge not found' })

       const memberId = req.member!._id
       const alreadyJoined = post.participants.some(
         (p: any) => p.toString() === memberId.toString()
       )
       if (alreadyJoined) return res.status(409).json({ error: 'Already joined' })

       post.participants.push(memberId)
       await post.save()
       res.json({ success: true, participantCount: post.participants.length })
     } catch (err) {
       console.error('Join challenge error:', err)
       res.status(500).json({ error: 'Failed to join challenge' })
     }
   })
   ```

   f. `GET /api/me/leaderboard` — top 10 by attendance this month
   ```typescript
   router.get('/leaderboard', async (req: Request, res: Response) => {
     try {
       const now = new Date()
       const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1)

       const leaderboard = await Attendance.aggregate([
         { $match: { gym: req.member!.gym, check_in_date: { $gte: startOfMonth } } },
         { $group: { _id: '$member', count: { $sum: 1 } } },
         { $sort: { count: -1 } },
         { $limit: 10 },
         { $lookup: { from: 'members', localField: '_id', foreignField: '_id', as: 'member' } },
         { $unwind: '$member' },
         { $project: {
           _id: 1,
           count: 1,
           name: '$member.name',
         }},
       ])

       // Privacy: show only first name + last initial
       const result = leaderboard.map((entry: any, i: number) => {
         const parts = entry.name.split(' ')
         const displayName = parts.length > 1
           ? `${parts[0]} ${parts[parts.length - 1][0]}.`
           : parts[0]
         return {
           rank: i + 1,
           name: displayName,
           count: entry.count,
           isMe: entry._id.toString() === req.member!._id.toString(),
         }
       })

       res.json(result)
     } catch (err) {
       console.error('Leaderboard error:', err)
       res.status(500).json({ error: 'Failed to load leaderboard' })
     }
   })
   ```

3. **Register in `app.ts`:**
   ```typescript
   import meRoutes from './routes/me.routes'
   // ...
   app.use('/api/me', meRoutes)
   ```

**Commit:** `feat(server): member API routes — home, profile, feed, leaderboard`

---

### Task 2: Owner Attendance Check-In Route + Badge Earning Logic

**Files:**
- Create: `server/src/routes/attendance.routes.ts`
- Modify: `server/src/app.ts` (register attendance routes)

**What to build:**

1. **`attendance.routes.ts`** — owner marks member check-in + triggers badge evaluation:
```typescript
import { Router, Request, Response } from 'express'
import { z } from 'zod'
import { requireAuth } from '../middleware/auth'
import { requireOwner } from '../middleware/roleGuard'
import { requireGymAccess } from '../middleware/gymAccess'
import { validate } from '../middleware/validate'
import { Attendance } from '../models/Attendance'
import { Member } from '../models/Member'

const router = Router({ mergeParams: true })

function todayIST(): string {
  return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' })
}

const checkInSchema = z.object({
  member_id: z.string().min(1),
})

// POST /api/gym/:gymId/attendance — mark check-in
router.post('/',
  requireAuth, requireOwner, requireGymAccess,
  validate(checkInSchema),
  async (req: Request, res: Response) => {
    try {
      const { member_id } = req.body
      const gymId = req.params.gymId
      const today = todayIST()

      const attendance = await Attendance.create({
        member: member_id,
        gym: gymId,
        check_in_date: new Date(today + 'T00:00:00.000Z'),
        checked_in_at: new Date(),
      })

      // Badge evaluation (async, don't block response)
      evaluateBadges(member_id, gymId).catch(err =>
        console.error('Badge eval error:', err)
      )

      res.status(201).json(attendance)
    } catch (err: any) {
      if (err.code === 11000) {
        return res.status(409).json({ error: 'Already checked in today' })
      }
      console.error('Check-in error:', err)
      res.status(500).json({ error: 'Failed to check in' })
    }
  }
)

// GET /api/gym/:gymId/attendance?date=YYYY-MM-DD — today's check-ins
router.get('/',
  requireAuth, requireOwner, requireGymAccess,
  async (req: Request, res: Response) => {
    try {
      const date = (req.query.date as string) || todayIST()
      const startOfDay = new Date(date + 'T00:00:00.000Z')
      const endOfDay = new Date(date + 'T23:59:59.999Z')

      const records = await Attendance.find({
        gym: req.params.gymId,
        check_in_date: { $gte: startOfDay, $lte: endOfDay },
      }).populate('member', 'name phone').lean()

      res.json(records)
    } catch (err) {
      console.error('Attendance list error:', err)
      res.status(500).json({ error: 'Failed to load attendance' })
    }
  }
)

// Badge evaluation logic
async function evaluateBadges(memberId: string, gymId: string) {
  const member = await Member.findById(memberId)
  if (!member) return

  const existingTypes = new Set(member.badges.map(b => b.badge_type))
  const newBadges: { badge_type: string; earned_at: Date }[] = []

  // Get all attendance records sorted desc
  const records = await Attendance.find({ member: memberId, gym: gymId })
    .sort({ check_in_date: -1 }).lean()

  const totalCheckins = records.length

  // first_week: 7 total check-ins
  if (!existingTypes.has('first_week') && totalCheckins >= 7) {
    newBadges.push({ badge_type: 'first_week', earned_at: new Date() })
  }

  // Streak calculation
  let streak = 0
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  const checkDates = new Set(
    records.map(r => new Date(r.check_in_date).toISOString().split('T')[0])
  )
  for (let i = 0; i < 365; i++) {
    const d = new Date(today)
    d.setDate(d.getDate() - i)
    const key = d.toISOString().split('T')[0]
    if (checkDates.has(key)) {
      streak++
    } else if (i > 0) {
      break
    }
    if (i === 0 && !checkDates.has(key)) continue
  }

  // 30_day_streak
  if (!existingTypes.has('30_day_streak') && streak >= 30) {
    newBadges.push({ badge_type: '30_day_streak', earned_at: new Date() })
  }

  // 100_day_club
  if (!existingTypes.has('100_day_club') && streak >= 100) {
    newBadges.push({ badge_type: '100_day_club', earned_at: new Date() })
  }

  // never_missed_monday: 4 consecutive Mondays
  if (!existingTypes.has('never_missed_monday')) {
    let mondayStreak = 0
    const d = new Date(today)
    // Go back to last Monday
    while (d.getDay() !== 1) d.setDate(d.getDate() - 1)
    for (let i = 0; i < 4; i++) {
      const key = d.toISOString().split('T')[0]
      if (checkDates.has(key)) {
        mondayStreak++
      } else {
        break
      }
      d.setDate(d.getDate() - 7)
    }
    if (mondayStreak >= 4) {
      newBadges.push({ badge_type: 'never_missed_monday', earned_at: new Date() })
    }
  }

  // Save new badges
  if (newBadges.length > 0) {
    await Member.findByIdAndUpdate(memberId, {
      $push: { badges: { $each: newBadges } }
    })
  }
}

export default router
```

2. **Register in `app.ts`:**
   ```typescript
   import attendanceRoutes from './routes/attendance.routes'
   // ...
   app.use('/api/gym/:gymId/attendance', attendanceRoutes)
   ```

**Commit:** `feat(server): attendance check-in with badge earning logic`

---

### Task 3: Public Routes (No Auth)

**Files:**
- Create: `server/src/routes/public.routes.ts`
- Modify: `server/src/app.ts` (register public routes)

**What to build:**

```typescript
import { Router, Request, Response } from 'express'
import { z } from 'zod'
import { validate } from '../middleware/validate'
import { Gym } from '../models/Gym'
import { GymPost } from '../models/GymPost'
import { Lead } from '../models/Lead'

const router = Router()

// GET /api/public/gym/:slug — public gym page data
router.get('/gym/:slug', async (req: Request, res: Response) => {
  try {
    const gym = await Gym.findOne({ slug: req.params.slug })
      .select('-owner -__v').lean()
    if (!gym) return res.status(404).json({ error: 'Gym not found' })
    res.json(gym)
  } catch (err) {
    console.error('Public gym error:', err)
    res.status(500).json({ error: 'Failed to load gym' })
  }
})

// GET /api/public/gym/:slug/posts — public posts
router.get('/gym/:slug/posts', async (req: Request, res: Response) => {
  try {
    const gym = await Gym.findOne({ slug: req.params.slug }).select('_id').lean()
    if (!gym) return res.status(404).json({ error: 'Gym not found' })

    const posts = await GymPost.find({ gym: gym._id, is_published: true })
      .select('-participants -__v')
      .sort({ created_at: -1 })
      .limit(20)
      .lean()

    res.json(posts)
  } catch (err) {
    console.error('Public posts error:', err)
    res.status(500).json({ error: 'Failed to load posts' })
  }
})

// POST /api/public/gym/:slug/leads — submit lead form
const leadSchema = z.object({
  name: z.string().min(1, 'Name required'),
  phone: z.string().regex(/^\d{10}$/, 'Phone must be 10 digits'),
  goal: z.enum(['weight_loss', 'muscle_gain', 'general']).optional(),
})

router.post('/gym/:slug/leads', validate(leadSchema), async (req: Request, res: Response) => {
  try {
    const gym = await Gym.findOne({ slug: req.params.slug }).select('_id').lean()
    if (!gym) return res.status(404).json({ error: 'Gym not found' })

    await Lead.create({
      gym: gym._id,
      name: req.body.name,
      phone: req.body.phone,
      goal: req.body.goal || null,
      source: 'gym_page',
    })

    res.status(201).json({ success: true, message: 'Thanks! The gym will contact you soon.' })
  } catch (err: any) {
    if (err.code === 11000) {
      return res.status(409).json({ error: 'You have already submitted' })
    }
    console.error('Lead submit error:', err)
    res.status(500).json({ error: 'Failed to submit' })
  }
})

export default router
```

Register: `app.use('/api/public', publicRoutes)`

**Commit:** `feat(server): public routes — gym page, posts, lead form`

---

### Task 4: Diet & Workout Template Data (Client Constants)

**Files:**
- Modify: `client/src/utils/constants.ts` (add DIET_TEMPLATES and WORKOUT_TEMPLATES)

**What to build:**

Add pre-built templates keyed by `goal_dietPref`:

```typescript
export interface MealPlan {
  name: string
  meals: {
    time: string
    label: string
    items: string[]
  }[]
  notes?: string
}

export const DIET_TEMPLATES: Record<string, MealPlan> = {
  'muscle_gain_veg': {
    name: 'Veg Muscle Gain Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['4 egg whites + 2 whole eggs (or paneer bhurji 200g)', 'Brown bread 2 slices', 'Banana 1', 'Milk 1 glass'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Handful of almonds + walnuts', 'Protein shake (whey/soy)'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Brown rice 1.5 cups', 'Rajma/Chole 1 bowl', 'Paneer sabzi 150g', 'Salad + curd'] },
      { time: '4:00 PM', label: 'Pre-Workout', items: ['Peanut butter sandwich', 'Black coffee'] },
      { time: '7:00 PM', label: 'Post-Workout', items: ['Protein shake', 'Banana 1'] },
      { time: '9:00 PM', label: 'Dinner', items: ['Roti 3', 'Dal 1 bowl', 'Paneer/Soya chunks 150g', 'Green vegetables'] },
    ],
    notes: 'Target: ~2500 cal, 120g protein. Adjust portions based on body weight.'
  },
  'muscle_gain_nonveg': {
    name: 'Non-Veg Muscle Gain Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['4 egg whites + 2 whole eggs', 'Oats 1 cup with milk', 'Banana 1'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Chicken breast 100g (grilled)', 'Brown bread 1 slice'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Brown rice 1.5 cups', 'Chicken curry 200g', 'Dal 1 bowl', 'Salad'] },
      { time: '4:00 PM', label: 'Pre-Workout', items: ['Peanut butter toast', 'Black coffee'] },
      { time: '7:00 PM', label: 'Post-Workout', items: ['Whey protein shake', 'Banana 1'] },
      { time: '9:00 PM', label: 'Dinner', items: ['Roti 2', 'Fish/Chicken 200g', 'Vegetables', 'Curd'] },
    ],
    notes: 'Target: ~2800 cal, 150g protein. Increase chicken/fish portions for higher protein.'
  },
  'muscle_gain_egg': {
    name: 'Eggetarian Muscle Gain Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['6 egg whites + 2 whole eggs', 'Brown bread 2 slices', 'Banana 1'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Protein shake', 'Mixed nuts'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Brown rice 1.5 cups', 'Paneer 150g', 'Dal 1 bowl', 'Egg curry 2 eggs', 'Salad'] },
      { time: '4:00 PM', label: 'Pre-Workout', items: ['Boiled eggs 2', 'Toast 1'] },
      { time: '7:00 PM', label: 'Post-Workout', items: ['Whey protein', 'Banana'] },
      { time: '9:00 PM', label: 'Dinner', items: ['Roti 3', 'Egg bhurji 3 eggs', 'Paneer sabzi', 'Curd'] },
    ],
    notes: 'Target: ~2600 cal, 130g protein.'
  },
  'weight_loss_veg': {
    name: 'Veg Weight Loss Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['Green tea', 'Oats with water/skimmed milk', 'Fruits (apple/papaya)'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Buttermilk 1 glass', 'Cucumber'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Brown rice 1 cup (or 2 roti)', 'Dal 1 bowl', 'Sabzi (low oil)', 'Big salad'] },
      { time: '4:00 PM', label: 'Evening', items: ['Green tea', 'Roasted chana 1 handful'] },
      { time: '7:30 PM', label: 'Dinner', items: ['Roti 1-2', 'Soup/dal', 'Steamed vegetables', 'Salad'] },
    ],
    notes: 'Target: ~1500 cal. Avoid fried food, sugar, maida. Drink 3-4L water daily.'
  },
  'weight_loss_nonveg': {
    name: 'Non-Veg Weight Loss Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['3 egg whites omelette', 'Brown bread 1 slice', 'Green tea'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Apple/cucumber', 'Buttermilk'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Brown rice 1 cup', 'Grilled chicken 150g', 'Salad (no dressing)', 'Curd'] },
      { time: '4:00 PM', label: 'Evening', items: ['Boiled egg 1', 'Green tea'] },
      { time: '7:30 PM', label: 'Dinner', items: ['Grilled fish 150g (or chicken soup)', 'Steamed vegetables', 'Salad'] },
    ],
    notes: 'Target: ~1600 cal, 100g protein. No fried food, sugar, or processed snacks.'
  },
  'weight_loss_egg': {
    name: 'Eggetarian Weight Loss Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['3 egg whites + 1 whole egg omelette', 'Brown bread 1 slice', 'Green tea'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Fruit (apple/orange)', 'Buttermilk'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Brown rice 1 cup', 'Dal 1 bowl', 'Sabzi (low oil)', 'Boiled egg 1', 'Salad'] },
      { time: '4:00 PM', label: 'Evening', items: ['Green tea', 'Roasted makhana'] },
      { time: '7:30 PM', label: 'Dinner', items: ['Roti 1-2', 'Egg curry (2 eggs, less oil)', 'Steamed vegetables'] },
    ],
    notes: 'Target: ~1500 cal, 80g protein.'
  },
  'general_veg': {
    name: 'Veg Balanced Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['Poha/Upma 1 bowl', 'Milk 1 glass', 'Fruit'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Mixed nuts handful', 'Buttermilk/lassi'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Rice/Roti 2', 'Dal 1 bowl', 'Sabzi 1 bowl', 'Curd', 'Salad'] },
      { time: '4:00 PM', label: 'Evening', items: ['Sprouts chaat', 'Tea (less sugar)'] },
      { time: '8:00 PM', label: 'Dinner', items: ['Roti 2', 'Paneer/Dal', 'Green vegetables', 'Salad'] },
    ],
    notes: 'Target: ~2000 cal. Balanced macros for general fitness.'
  },
  'general_nonveg': {
    name: 'Non-Veg Balanced Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['Eggs 2 (any style)', 'Toast 2 slices', 'Juice/Milk'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Fruit + nuts'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Rice/Roti 2', 'Chicken/Fish 150g', 'Dal', 'Salad'] },
      { time: '4:00 PM', label: 'Evening', items: ['Tea', 'Biscuits/chana'] },
      { time: '8:00 PM', label: 'Dinner', items: ['Roti 2', 'Egg curry or chicken', 'Vegetables', 'Curd'] },
    ],
    notes: 'Target: ~2200 cal. Well-rounded for general fitness.'
  },
  'general_egg': {
    name: 'Eggetarian Balanced Plan',
    meals: [
      { time: '7:00 AM', label: 'Breakfast', items: ['Eggs 2 (boiled/omelette)', 'Paratha 1', 'Curd'] },
      { time: '10:00 AM', label: 'Mid-Morning', items: ['Banana', 'Milk'] },
      { time: '1:00 PM', label: 'Lunch', items: ['Rice/Roti 2', 'Dal', 'Paneer sabzi', 'Salad', 'Curd'] },
      { time: '4:00 PM', label: 'Evening', items: ['Boiled egg 1', 'Tea', 'Makhana'] },
      { time: '8:00 PM', label: 'Dinner', items: ['Roti 2', 'Egg curry 2 eggs', 'Vegetables'] },
    ],
    notes: 'Target: ~2000 cal.'
  },
}

export interface WorkoutDay {
  day: string
  focus: string
  exercises: { name: string; sets: string; rest: string }[]
}

export interface WorkoutPlan {
  name: string
  schedule: WorkoutDay[]
  notes?: string
}

export const WORKOUT_TEMPLATES: Record<string, WorkoutPlan> = {
  'muscle_gain': {
    name: 'Push-Pull-Legs (Muscle Gain)',
    schedule: [
      { day: 'Day 1', focus: 'Push (Chest + Shoulders + Triceps)', exercises: [
        { name: 'Flat Bench Press', sets: '4 × 8-10', rest: '90s' },
        { name: 'Incline Dumbbell Press', sets: '3 × 10-12', rest: '60s' },
        { name: 'Overhead Press', sets: '3 × 8-10', rest: '90s' },
        { name: 'Lateral Raises', sets: '3 × 12-15', rest: '45s' },
        { name: 'Tricep Pushdowns', sets: '3 × 12-15', rest: '45s' },
        { name: 'Overhead Tricep Extension', sets: '3 × 10-12', rest: '45s' },
      ]},
      { day: 'Day 2', focus: 'Pull (Back + Biceps)', exercises: [
        { name: 'Deadlift', sets: '4 × 6-8', rest: '120s' },
        { name: 'Lat Pulldown', sets: '3 × 10-12', rest: '60s' },
        { name: 'Seated Cable Row', sets: '3 × 10-12', rest: '60s' },
        { name: 'Face Pulls', sets: '3 × 15', rest: '45s' },
        { name: 'Barbell Curls', sets: '3 × 10-12', rest: '45s' },
        { name: 'Hammer Curls', sets: '3 × 10-12', rest: '45s' },
      ]},
      { day: 'Day 3', focus: 'Legs + Core', exercises: [
        { name: 'Squats', sets: '4 × 8-10', rest: '120s' },
        { name: 'Leg Press', sets: '3 × 10-12', rest: '90s' },
        { name: 'Romanian Deadlift', sets: '3 × 10-12', rest: '60s' },
        { name: 'Leg Curls', sets: '3 × 12-15', rest: '45s' },
        { name: 'Calf Raises', sets: '4 × 15-20', rest: '30s' },
        { name: 'Hanging Leg Raises', sets: '3 × 12-15', rest: '45s' },
      ]},
      { day: 'Day 4', focus: 'Rest', exercises: [] },
      { day: 'Day 5', focus: 'Repeat Day 1', exercises: [] },
      { day: 'Day 6', focus: 'Repeat Day 2', exercises: [] },
      { day: 'Day 7', focus: 'Rest', exercises: [] },
    ],
    notes: 'Progressive overload: increase weight by 2.5kg when you hit top reps for all sets.'
  },
  'weight_loss': {
    name: 'Fat Burn + Strength (Weight Loss)',
    schedule: [
      { day: 'Day 1', focus: 'Full Body + HIIT', exercises: [
        { name: 'Goblet Squats', sets: '3 × 15', rest: '45s' },
        { name: 'Push-ups', sets: '3 × 12-15', rest: '30s' },
        { name: 'Dumbbell Rows', sets: '3 × 12', rest: '45s' },
        { name: 'Lunges (each leg)', sets: '3 × 12', rest: '30s' },
        { name: 'Plank', sets: '3 × 45s', rest: '30s' },
        { name: 'HIIT Cardio (treadmill/cycling)', sets: '15 min', rest: '—' },
      ]},
      { day: 'Day 2', focus: 'Cardio + Core', exercises: [
        { name: 'Treadmill Walk (incline 10-15%)', sets: '20 min', rest: '—' },
        { name: 'Cycling', sets: '15 min', rest: '—' },
        { name: 'Crunches', sets: '3 × 20', rest: '30s' },
        { name: 'Russian Twists', sets: '3 × 20', rest: '30s' },
        { name: 'Mountain Climbers', sets: '3 × 30s', rest: '30s' },
        { name: 'Leg Raises', sets: '3 × 15', rest: '30s' },
      ]},
      { day: 'Day 3', focus: 'Upper Body + Cardio', exercises: [
        { name: 'Dumbbell Bench Press', sets: '3 × 12', rest: '45s' },
        { name: 'Lat Pulldown', sets: '3 × 12', rest: '45s' },
        { name: 'Shoulder Press', sets: '3 × 12', rest: '45s' },
        { name: 'Bicep Curls', sets: '3 × 15', rest: '30s' },
        { name: 'Tricep Dips', sets: '3 × 12', rest: '30s' },
        { name: 'Steady State Cardio', sets: '20 min', rest: '—' },
      ]},
      { day: 'Day 4', focus: 'Rest / Light Walk', exercises: [] },
      { day: 'Day 5', focus: 'Repeat Day 1', exercises: [] },
      { day: 'Day 6', focus: 'Repeat Day 2', exercises: [] },
      { day: 'Day 7', focus: 'Rest', exercises: [] },
    ],
    notes: 'Keep heart rate at 60-75% max during cardio. Stay in calorie deficit.'
  },
  'general': {
    name: 'Full Body 3-Day (General Fitness)',
    schedule: [
      { day: 'Day 1', focus: 'Full Body A', exercises: [
        { name: 'Squats', sets: '3 × 10-12', rest: '60s' },
        { name: 'Bench Press', sets: '3 × 10-12', rest: '60s' },
        { name: 'Barbell Rows', sets: '3 × 10-12', rest: '60s' },
        { name: 'Overhead Press', sets: '3 × 10-12', rest: '60s' },
        { name: 'Plank', sets: '3 × 30-45s', rest: '30s' },
      ]},
      { day: 'Day 2', focus: 'Rest / Light Cardio', exercises: [] },
      { day: 'Day 3', focus: 'Full Body B', exercises: [
        { name: 'Deadlift', sets: '3 × 8-10', rest: '90s' },
        { name: 'Dumbbell Press (incline)', sets: '3 × 10-12', rest: '60s' },
        { name: 'Lat Pulldown', sets: '3 × 10-12', rest: '60s' },
        { name: 'Lunges', sets: '3 × 10 each', rest: '60s' },
        { name: 'Bicycle Crunches', sets: '3 × 20', rest: '30s' },
      ]},
      { day: 'Day 4', focus: 'Rest / Light Cardio', exercises: [] },
      { day: 'Day 5', focus: 'Full Body C', exercises: [
        { name: 'Leg Press', sets: '3 × 12', rest: '60s' },
        { name: 'Push-ups', sets: '3 × 15', rest: '45s' },
        { name: 'Cable Rows', sets: '3 × 12', rest: '60s' },
        { name: 'Lateral Raises', sets: '3 × 15', rest: '30s' },
        { name: 'Hanging Leg Raises', sets: '3 × 10-12', rest: '45s' },
      ]},
      { day: 'Day 6-7', focus: 'Rest', exercises: [] },
    ],
    notes: 'Great starting plan. Focus on form first, then increase weight gradually.'
  },
}
```

**Commit:** `feat(client): diet and workout template data in constants`

---

### Task 5: Client API Modules (Member + Public)

**Files:**
- Create: `client/src/api/me.ts`
- Create: `client/src/api/public.ts`

**What to build:**

1. **`me.ts`** — member-facing API:
```typescript
import api from './axios'

export async function getHome() {
  const { data } = await api.get('/me/home')
  return data
}

export async function getProfile() {
  const { data } = await api.get('/me/profile')
  return data
}

export async function updateProfile(updates: { goal?: string; diet_pref?: string }) {
  const { data } = await api.put('/me/profile', updates)
  return data
}

export async function getFeed() {
  const { data } = await api.get('/me/feed')
  return data
}

export async function joinChallenge(postId: string) {
  const { data } = await api.post(`/me/feed/${postId}/join`)
  return data
}

export async function getLeaderboard() {
  const { data } = await api.get('/me/leaderboard')
  return data
}
```

2. **`public.ts`** — public API (no auth):
```typescript
import axios from 'axios'

const baseURL = import.meta.env.VITE_API_URL || '/api'

export async function getPublicGym(slug: string) {
  const { data } = await axios.get(`${baseURL}/public/gym/${slug}`)
  return data
}

export async function getPublicPosts(slug: string) {
  const { data } = await axios.get(`${baseURL}/public/gym/${slug}/posts`)
  return data
}

export async function submitLead(slug: string, leadData: { name: string; phone: string; goal?: string }) {
  const { data } = await axios.post(`${baseURL}/public/gym/${slug}/leads`, leadData)
  return data
}
```

3. **Add to owner API** — `client/src/api/members.ts` — add attendance function:
```typescript
export async function checkInMember(gymId: string, memberId: string) {
  const { data } = await api.post(`/gym/${gymId}/attendance`, { member_id: memberId })
  return data
}

export async function getTodayAttendance(gymId: string) {
  const { data } = await api.get(`/gym/${gymId}/attendance`)
  return data
}
```

**Commit:** `feat(client): member + public API modules, owner attendance API`

---

### Task 6: MemberLayout + Member Home Page

**Files:**
- Create: `client/src/components/layout/MemberLayout.tsx`
- Rewrite: `client/src/pages/member/Home.tsx`
- Modify: `client/src/App.tsx` (add MemberLayout + nested routes)

**What to build:**

1. **`MemberLayout.tsx`** — same pattern as OwnerLayout but with member nav:
```typescript
import { Outlet } from 'react-router-dom'
import { BottomNav, memberNavItems } from './BottomNav'

export default function MemberLayout() {
  return (
    <div className="pb-20">
      <header className="sticky top-0 z-40 bg-bg-primary border-b border-border px-4 py-3 pt-[env(safe-area-inset-top)]">
        <div className="flex items-center justify-between">
          <h1 className="text-lg font-bold text-accent-orange">RepCount</h1>
          <span className="text-xs text-text-secondary">Member</span>
        </div>
      </header>
      <main>
        <Outlet />
      </main>
      <BottomNav items={memberNavItems} />
    </div>
  )
}
```

2. **`Home.tsx`** — member home with streak, plan status, attendance grid, badges:
   - Call `getHome()` on mount
   - Show: greeting + gym name, streak card (flame icon + count), plan status card, 30-day attendance grid (calendar-style dots), earned badges row, quick links
   - The 30-day grid: render a 7-column grid of the last 30 days, highlight days with check-ins in green

3. **`App.tsx`** — update member routes to use MemberLayout with nested routes:
```tsx
import MemberLayout from '@/components/layout/MemberLayout'
import MemberHome from '@/pages/member/Home'
import DietPage from '@/pages/member/Diet'
import WorkoutPage from '@/pages/member/Workout'
import FeedPage from '@/pages/member/Feed'
import ProfilePage from '@/pages/member/Profile'

// Replace the single /m route with:
<Route path="/m" element={
  <ProtectedRoute requiredRole="member">
    <MemberLayout />
  </ProtectedRoute>
}>
  <Route index element={<MemberHome />} />
  <Route path="diet" element={<DietPage />} />
  <Route path="workout" element={<WorkoutPage />} />
  <Route path="feed" element={<FeedPage />} />
  <Route path="profile" element={<ProfilePage />} />
</Route>
```

**Commit:** `feat(client): MemberLayout + member Home page with streak and attendance`

---

### Task 7: Member Diet + Workout Pages

**Files:**
- Create: `client/src/pages/member/Diet.tsx`
- Create: `client/src/pages/member/Workout.tsx`

**What to build:**

1. **`Diet.tsx`** — displays diet plan based on member's goal + diet_pref:
   - Call `getHome()` (or use a context/prop) to get member's goal + diet_pref
   - Look up `DIET_TEMPLATES[goal_dietPref]`
   - Render meals as accordion cards: time + label as header, items as list
   - Show notes at bottom
   - If no matching template, show fallback message

2. **`Workout.tsx`** — displays workout plan based on member's goal:
   - Look up `WORKOUT_TEMPLATES[goal]`
   - Render schedule as day cards: day label + focus as header, exercises table (name, sets, rest)
   - Show notes at bottom
   - Rest days shown with "Rest / Recovery" message

Both pages should call `getHome()` API to get the member's goal/diet_pref, then render the matching template from constants.

**Commit:** `feat(client): member Diet + Workout pages with pre-built templates`

---

### Task 8: Member Feed + Profile Pages

**Files:**
- Create: `client/src/pages/member/Feed.tsx`
- Create: `client/src/pages/member/Profile.tsx`

**What to build:**

1. **`Feed.tsx`** — gym posts feed:
   - Call `getFeed()` on mount
   - Render posts as cards: post_type badge, title, body, dates if present
   - Challenge posts: show participant count + "Join Challenge" button (calls `joinChallenge(postId)`)
   - After joining: button changes to "Joined" (disabled, green)
   - Empty state: "No posts from your gym yet"

2. **`Profile.tsx`** — member profile + badges + logout:
   - Call `getProfile()` on mount
   - Show: name, phone, goal (editable dropdown), diet_pref (editable dropdown)
   - Save changes via `updateProfile({ goal, diet_pref })`
   - Badges section: grid of earned badges (emoji + label from BADGE_TYPES)
   - Unearned badges shown as locked/gray
   - Payment history from memberships
   - Logout button

**Commit:** `feat(client): member Feed + Profile pages`

---

### Task 9: Member Leaderboard Page

**Files:**
- Create: `client/src/pages/member/Leaderboard.tsx`
- Modify: `client/src/components/layout/BottomNav.tsx` (update member nav — replace Feed with Leaderboard? Or add as sub-page)

**Decision:** Keep Feed in bottom nav. Leaderboard accessible from Home page as a link card.

**What to build:**

1. **`Leaderboard.tsx`** — monthly attendance leaderboard:
   - Call `getLeaderboard()` on mount
   - Show top 10 as numbered list cards
   - Current user highlighted with accent border
   - Show: rank number, display name (privacy-safe), check-in count
   - Gold/Silver/Bronze colors for top 3

2. **Add route in App.tsx:** `<Route path="leaderboard" element={<LeaderboardPage />} />`

3. **Add link from Home.tsx:** Quick action card linking to `/m/leaderboard`

**Commit:** `feat(client): member Leaderboard page`

---

### Task 10: Owner Check-In UI (Members Page Enhancement)

**Files:**
- Modify: `client/src/pages/owner/Members.tsx` (add check-in button)
- Modify: `client/src/pages/owner/MemberDetail.tsx` (add check-in button)

**What to build:**

1. **Members.tsx** — add "Check In" button next to each member in the list:
   - Small green button/icon next to member name
   - On click: calls `checkInMember(gymId, memberId)`
   - On success: show brief toast/badge "Checked in!"
   - On 409 (already checked in): show "Already checked in today"

2. **MemberDetail.tsx** — add check-in button in quick actions:
   - Add "Check In" as a third quick action button
   - Same logic as above

**Commit:** `feat(client): owner check-in buttons on Members + MemberDetail pages`

---

### Task 11: Public Gym Page

**Files:**
- Create: `client/src/pages/public/GymPage.tsx`
- Modify: `client/src/App.tsx` (add public route)

**What to build:**

1. **`GymPage.tsx`** — public-facing gym profile:
   - Route: `/gym/:slug` (no auth required)
   - Call `getPublicGym(slug)` + `getPublicPosts(slug)` on mount
   - Sections:
     - Hero: gym name, city, description
     - Info cards: address, phone, timings (opening_time – closing_time)
     - Facilities: chip/tag grid
     - Pricing: 4-column pricing table (monthly/quarterly/half_yearly/yearly)
     - Recent posts: challenge/event/offer cards (max 5)
     - CTA: "Join This Gym" button → opens lead form modal
   - Lead form modal: name, phone (10 digits), goal (dropdown), submit
   - On submit: `submitLead(slug, data)` → success message
   - Mobile-first, dark theme (same as rest of app)

2. **App.tsx route:** `<Route path="/gym/:slug" element={<GymPage />} />`

**Commit:** `feat(client): public gym page with lead form`

---

### Task 12: Member-User Linking + Final Wiring

**Files:**
- Modify: `server/src/routes/auth.routes.ts` (link Member.user on login)

**What to build:**

When a user logs in and has role `member`, check if there's a Member record with matching phone but `user: null`. If found, link it:

```typescript
// In verify-otp handler, after finding/creating User:
if (user.role === 'member') {
  await Member.updateOne(
    { phone: user.phone.replace('+91', ''), user: null },
    { $set: { user: user._id } }
  )
}
```

This allows the owner to add a member first (with phone), then when that member logs in, their accounts get linked.

**Commit:** `feat(server): auto-link member record to user on login`

---

### Task 13: TypeScript Check + Integration Test

**Steps:**
1. Run `cd server && npx tsc --noEmit` — fix any errors
2. Run `cd client && npx tsc --noEmit` — fix any errors
3. Start both servers: `npm run dev`
4. Test full flow via curl:
   - Public: GET gym page, POST lead
   - Owner: login, check-in member, verify badge earned
   - Member: login (auto-link), GET home (streak + attendance), GET feed, GET leaderboard, GET profile, PUT profile
5. Test in browser: login as member, navigate all pages

**Commit:** `fix: M3-M5 integration fixes`

---

## Summary

| Task | Description | Creates/Modifies |
|------|-------------|-----------------|
| 1 | Member context middleware + API routes | server middleware + me.routes.ts |
| 2 | Owner attendance check-in + badge logic | server attendance.routes.ts |
| 3 | Public routes (gym page, posts, leads) | server public.routes.ts |
| 4 | Diet + workout template data | client constants.ts |
| 5 | Client API modules (member + public) | client api/me.ts, api/public.ts |
| 6 | MemberLayout + Home page | client layout + Home.tsx + App.tsx |
| 7 | Diet + Workout pages | client Diet.tsx, Workout.tsx |
| 8 | Feed + Profile pages | client Feed.tsx, Profile.tsx |
| 9 | Leaderboard page | client Leaderboard.tsx |
| 10 | Owner check-in UI | client Members.tsx, MemberDetail.tsx |
| 11 | Public gym page + lead form | client GymPage.tsx |
| 12 | Member-user linking on login | server auth.routes.ts |
| 13 | TypeScript + integration test | both |
